<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Patrick Schratz" />


<title>Parallel Modes of sperrorest</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Parallel Modes of <code>sperrorest</code></h1>
<h4 class="author"><em>Patrick Schratz</em></h4>


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#the-future-backend">The <code>future</code> backend</a></li>
<li><a href="#mode-foreach">Mode “foreach”</a></li>
<li><a href="#mode-apply">Mode “apply”</a></li>
<li><a href="#mode-future">Mode “future”</a></li>
<li><a href="#mode-sequential">Mode “sequential”</a></li>
<li><a href="#performance-comparison">Performance comparison</a></li>
</ul>
</div>

<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p><code>sperrorest</code> is parallelized by default from v2.0.0 and higher.</p>
<p>Most users are not familiar with parallelization and have no time/motivation to wrap their head around it. Instead, they just accept to wait “a bit” longer until the process finishes.</p>
<p>While this is no problem for “quick” cross-validation (CV) cases with a low number of repetitions and models which converge quickly, in some cases processing may take up to several months. For example, running a spatial cross-validation using a Generalized Linear Mixed Model (GLMM) with both random effects and a spatial autocorrelation structure on around 1000 observations takes roughly this time, if executed sequentially. Most of the fitting time hereby is devoted to the integration of the spatial autocorrelation structure.</p>
<p><code>sperrorest</code> comes with four different parallelization modes and also offers sequential execution.</p>
<p>Unless specified otherwise, all cores of the machine are used. Limiting the number of cores makes sense in cases when you want to do other work on your machine while running a cross-validation so that your system stays responsive. Also, if you are working on a server and have, let’s say, 48 cores available and want to do a 100 repetition CV. Since most models take roughly the same time to fit, it would be smart to use 34 cores. Taking this number of cores is faster than using 48 because</p>
<ol style="list-style-type: decimal">
<li><p>You need 3 iterations (34 in the first, 68 in the second and finishing in the 3rd) to process all repetitions. During the third iteration, a lot of cores would do nothing else but just wait for the others to finish.</p></li>
<li><p>The parallelization overhead, which is mainly caused by splitting and combining all jobs to the workers, would be higher for the case with 48 cores than for 34 cores. Hence, 34 cores will finish faster than 48 cores on 100 repetitions. Of course, when taking 50 cores it would only need 2 worker iterations to process everything which would again speed up the process.</p></li>
</ol>
</div>
<div id="the-future-backend" class="section level1">
<h1>The <code>future</code> backend</h1>
<p>All modes expect <code>&quot;apply&quot;</code> (including the sequential one) are running on the parallel API of the <a href="https://github.com/HenrikBengtsson/future"><code>future</code></a> package. It offers a unified, cross-platform API combining all other existing parallel approaches of R into one package. Besides the variety of parallel options to choose from (<code>multiprocess</code>, <code>multisession</code>, <code>multicore</code>, <code>cluster</code>, etc.) it also provides a <code>sequential</code> option. Every options is initiated in the same way:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(future)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">registerDoFuture</span>()</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">plan</span>(<span class="st">&quot;sequential&quot;</span>) <span class="co"># sequential</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">plan</span>(<span class="st">&quot;multicore&quot;</span>) <span class="co"># parallel (Unix only)</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">plan</span>(<span class="st">&quot;multisession&quot;</span>) <span class="co"># parallel</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">plan</span>(<span class="st">&quot;multiprocess&quot;</span>) <span class="co"># parallel</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">plan</span>(<span class="st">&quot;cluster&quot;</span>) <span class="co"># parallel</span></a></code></pre></div>
<p>Every option has its advantages and disadvantages. Check the <code>future</code> package vignettes for more information.</p>
</div>
<div id="mode-foreach" class="section level1">
<h1>Mode “foreach”</h1>
<p>Unless specified otherwise, the default parallel mode uses <code>foreach</code> with the <code>&quot;cluster&quot;</code> option of the <code>future</code> package. Package <a href="https://github.com/HenrikBengtsson/doFuture"><code>doFuture</code></a> takes care that <code>foreach</code> works with the parallel initialization of the <code>future</code> package.</p>
<p>This option is taken as default because it works cross-platform and provides progress output to the console. Unfortunately, on Windows this output is not shown to the console but needs to be written to a file (default to the current working directory). Another downside is that the global environment needs to copied to every worker before processing starts. Workers are started sequentially and therefore the startup of &gt; 10 workers may take some seconds.</p>
</div>
<div id="mode-apply" class="section level1">
<h1>Mode “apply”</h1>
<p>This mode is also cross-platform but uses different functions on Unix/non-Unix systems for actual processing. On Unix, it uses the <a href="https://github.com/kvnkuang/pbmcapply"><code>pbmcapply</code></a> package which combines the <a href="https://github.com/psolymos/pbapply"><code>pbapply</code></a> package (provides progress bar for ‘apply’ functions) and the <code>future</code> package to speed up processing. On Windows, <code>pbapply</code> is used which in the end uses <code>parApply()</code> to setup a cluster like parallelization including a progress bar.</p>
</div>
<div id="mode-future" class="section level1">
<h1>Mode “future”</h1>
<p>This modes entirely uses the <code>future</code> package in combination with <code>future_lapply()</code> as the working horse. It can be used with any <code>future</code> plan specified via <code>par_option</code>. It is the fastest mode but provides no progress output.</p>
</div>
<div id="mode-sequential" class="section level1">
<h1>Mode “sequential”</h1>
<p>This mode executes <code>sperrorest()</code> sequentially. It also runs on the <code>future</code> API using <code>foreach</code>/<a href="https://github.com/HenrikBengtsson/doFuture"><code>doFuture</code></a> which provide the possibility of sequential execution using <code>plan(&quot;sequential&quot;)</code>.</p>
</div>
<div id="performance-comparison" class="section level1">
<h1>Performance comparison</h1>
<p>Example setup:</p>
<ul>
<li>Machine: 48 cores, Debian 9 (stretch)</li>
<li>100 repetitions, 5 folds</li>
<li>100 variable importance permutations using all variables</li>
<li>non-spatial partitioning (<code>partition_cv</code>)</li>
<li>Model: <code>glm</code></li>
<li>Response type: binary</li>
<li>Progress: None</li>
</ul>
<p>Note that the only argument which needs to be changed is <code>par_mode</code> here. Subsequently, <code>par_mode = &quot;foreach&quot;</code>, <code>par_mode = &quot;apply&quot;</code> and <code>par_mode = &quot;future&quot;</code> were used.</p>
<p>All default settings of each mode were used. <code>par_mode = &quot;foreach&quot;</code> runs on <code>plan(&quot;cluster&quot;)</code> while <code>par_mode = &quot;future&quot;</code> runs on <code>plan(&quot;multiprocess&quot;)</code>. Mode <code>&quot;apply&quot;</code> used <code>pbmcapply</code> in the end since the test was running on a Unix System.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">data</span>(ecuador)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">fo &lt;-<span class="st"> </span>slides <span class="op">~</span><span class="st"> </span>dem <span class="op">+</span><span class="st"> </span>slope <span class="op">+</span><span class="st"> </span>hcurv <span class="op">+</span><span class="st"> </span>vcurv <span class="op">+</span><span class="st"> </span>log.carea <span class="op">+</span><span class="st"> </span>cslope</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">sperrorest</span>(<span class="dt">data =</span> ecuador, <span class="dt">formula =</span> fo,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">           <span class="dt">model_fun =</span> glm, <span class="dt">model_args =</span> <span class="kw">list</span>(<span class="dt">family =</span> <span class="st">&quot;binomial&quot;</span>),</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">           <span class="dt">pred_args =</span> <span class="kw">list</span>(<span class="dt">type =</span> <span class="st">&quot;response&quot;</span>),</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">           <span class="dt">smp_fun =</span> partition_cv,</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">           <span class="dt">smp_args =</span> <span class="kw">list</span>(<span class="dt">repetition =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">100</span>, <span class="dt">nfold =</span> <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">           <span class="dt">par_args =</span> <span class="kw">list</span>(<span class="dt">par_mode =</span> <span class="st">&quot;foreach&quot;</span>, <span class="dt">par_units =</span> <span class="dv">20</span>),</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">           <span class="dt">benchmark =</span> <span class="ot">TRUE</span>, <span class="dt">progress =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">           <span class="dt">importance =</span> <span class="ot">TRUE</span>, <span class="dt">imp_permutations =</span> <span class="dv">100</span>)</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th>foreach</th>
<th>apply</th>
<th>future</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>runtime (min)</td>
<td>52.33</td>
<td>51.67</td>
<td>49.54</td>
<td></td>
</tr>
</tbody>
</table>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
